<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Git Diff Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background-color: #f6f8fa;
            color: #1f2328;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: #fff;
            border-bottom: 1px solid #d0d7de;
            padding: 16px 20px;
            box-shadow: 0 1px 3px rgba(16,22,26,0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .approve-button {
            background: #1f883d;
            color: white;
            border: 1px solid #1f883d;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: background-color 0.2s;
        }

        .approve-button:hover {
            background: #1a7f37;
            border-color: #1a7f37;
        }

        .approve-button:disabled {
            background: #8b949e;
            border-color: #8b949e;
            cursor: not-allowed;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 65px);
            background: #fff;
        }

        .files-sidebar {
            width: 300px;
            border-right: 1px solid #d0d7de;
            background: #fff;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .files-sidebar-header {
            background: #f6f8fa;
            padding: 12px 16px;
            border-bottom: 1px solid #d0d7de;
            font-weight: 600;
            font-size: 14px;
            color: #24292f;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .files-count {
            background: #eaeef2;
            color: #656d76;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 500;
        }

        .diff-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .diff-pane {
            flex: 1;
            overflow-y: auto;
            background: #fff;
            border-right: 1px solid #d0d7de;
        }

        .diff-pane:last-child {
            border-right: none;
        }

        .diff-pane-header {
            background: #f6f8fa;
            border-bottom: 1px solid #d0d7de;
            padding: 8px 12px;
            font-weight: 600;
            font-size: 14px;
            color: #656d76;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .file-section {
            border-bottom: 1px solid #d0d7de;
        }

        .file-header {
            background: #f6f8fa;
            padding: 8px 12px;
            font-weight: 600;
            font-size: 14px;
            color: #24292f;
            border-bottom: 1px solid #d0d7de;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .diff-line {
            display: flex;
            font-family: 'SFMono-Regular', 'Consolas', 'Liberation Mono', 'Menlo', monospace;
            font-size: 12px;
            line-height: 20px;
        }

        .line-number {
            background: #f6f8fa;
            border-right: 1px solid #d0d7de;
            color: #656d76;
            padding: 0 8px;
            text-align: right;
            min-width: 80px;
            user-select: none;
            display: flex;
            align-items: center;
        }

        .line-content {
            flex: 1;
            padding: 0 8px;
            white-space: pre;
            overflow-x: auto;
        }

        .addition-line {
            background-color: #d1f4d0;
        }

        .deletion-line {
            background-color: #ffd8d3;
        }

        .context-line {
            background-color: #fff;
        }

        .addition-line .line-content {
            background-color: #d1f4d0;
        }

        .deletion-line .line-content {
            background-color: #ffd8d3;
        }

        .empty-line {
            background-color: #fafbfc;
        }

        .file-tree {
            padding: 8px 0;
        }

        .file-tree-item {
            display: flex;
            align-items: center;
            padding: 6px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #24292f;
        }

        .file-tree-item:hover {
            background-color: #f6f8fa;
        }

        .file-tree-item.active {
            background-color: #dbeafe;
        }

        .file-name {
            margin-left: 6px;
            flex: 1;
        }

        .file-changes {
            margin-left: auto;
            font-size: 12px;
        }

        .additions {
            color: #1a7f37;
            margin-right: 4px;
        }

        .deletions {
            color: #d1242f;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Git Diff Viewer</h1>
        <button id="approve-button" class="approve-button">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"/>
            </svg>
            Approve
        </button>
    </div>

    <div class="main-container">
        <div class="files-sidebar">
            <div class="files-sidebar-header">
                Files changed
                <span class="files-count" id="files-count">0</span>
            </div>
            <div class="file-tree" id="file-tree">
                <!-- File tree will be populated here -->
            </div>
        </div>

        <div class="diff-container">
            <div class="diff-pane" id="old-pane">
                <div class="diff-pane-header">Original</div>
                <div id="old-content">
                    <!-- Original file content will be populated here -->
                </div>
            </div>
            <div class="diff-pane" id="new-pane">
                <div class="diff-pane-header">Modified</div>
                <div id="new-content">
                    <!-- Modified file content will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        
        // Parse query parameters to determine diff type
        const urlParams = new URLSearchParams(window.location.search);
        const commit = urlParams.get('commit');
        const range = urlParams.get('range');
        const since = urlParams.get('since');
        const live = urlParams.get('live') === 'true';

        // API Client for communication with backend
        class ApiClient {
            constructor(baseUrl = '') {
                this.baseUrl = baseUrl;
            }
            
            async getDiff(options = {}) {
                const { commit, range } = options;
                
                const params = new URLSearchParams();
                if (commit) params.append('commit', commit);
                if (range) params.append('range', range);
                
                const response = await fetch(`${this.baseUrl}/api/diff?${params}`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch diff: ${response.statusText}`);
                }
                return await response.json();
            }
            
            async getLiveDiff(since = 'HEAD') {
                const params = new URLSearchParams();
                if (since) params.append('since', since);
                
                const response = await fetch(`${this.baseUrl}/api/diff/live?${params}`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch live diff: ${response.statusText}`);
                }
                return await response.json();
            }
            
            async approve() {
                // Extract review ID from current URL
                const pathParts = window.location.pathname.split('/review/');
                const reviewId = pathParts.length > 1 ? pathParts[1].split('/')[0] : 'default';
                
                const response = await fetch(`/review/${reviewId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        timestamp: new Date().toISOString()
                    }),
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to approve: ${response.statusText}`);
                }
                return await response.json();
            }
        }
        
        // Initialize API client with root base URL
        const apiClient = new ApiClient('');

        // Render diff content
        function renderDiff(diff) {
            const oldContent = document.getElementById('old-content');
            const newContent = document.getElementById('new-content');
            const fileTree = document.getElementById('file-tree');
            const filesCount = document.getElementById('files-count');
            
            oldContent.innerHTML = '';
            newContent.innerHTML = '';
            fileTree.innerHTML = '';
            
            // Update files count
            filesCount.textContent = diff.files.length;
            
            // Render file tree
            diff.files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-tree-item';
                fileItem.innerHTML = `
                    <span class="file-name">${file.path}</span>
                    <span class="file-changes">
                        <span class="additions">+${file.additions}</span>
                        <span class="deletions">−${file.deletions}</span>
                    </span>
                `;
                fileTree.appendChild(fileItem);
            });

            // Render diff content
            diff.files.forEach(file => {
                // Create file sections
                const oldFileSection = createFileSection(file, 'old');
                const newFileSection = createFileSection(file, 'new');
                
                oldContent.appendChild(oldFileSection);
                newContent.appendChild(newFileSection);
            });
        }

        function createFileSection(file, side) {
            const section = document.createElement('div');
            section.className = 'file-section';
            
            // File header
            const header = document.createElement('div');
            header.className = 'file-header';
            header.innerHTML = `<span>${file.path}</span>`;
            section.appendChild(header);
            
            // Diff content
            const diffContent = document.createElement('div');
            diffContent.className = 'diff-content';
            
            if (file.chunks && file.chunks.length > 0) {
                file.chunks.forEach(chunk => {
                    chunk.lines.forEach(line => {
                        const lineElement = createLineElement(line, side);
                        if (lineElement) {
                            diffContent.appendChild(lineElement);
                        }
                    });
                });
            }
            
            section.appendChild(diffContent);
            return section;
        }

        function createLineElement(line, side) {
            const lineDiv = document.createElement('div');
            lineDiv.className = 'diff-line';
            
            // Determine what to show based on side and line type
            let shouldShow = true;
            let cssClass = 'context-line';
            let indicator = '';
            
            if (side === 'old') {
                if (line.type === 'addition') {
                    shouldShow = false; // Don't show additions in old pane
                } else {
                    if (line.type === 'deletion') {
                        cssClass = 'deletion-line';
                        indicator = '−';
                    }
                }
            } else { // new side
                if (line.type === 'deletion') {
                    shouldShow = false; // Don't show deletions in new pane
                } else {
                    if (line.type === 'addition') {
                        cssClass = 'addition-line';
                        indicator = '+';
                    }
                }
            }
            
            if (!shouldShow) {
                // Create empty line to maintain alignment
                lineDiv.className = 'diff-line empty-line';
                lineDiv.innerHTML = `
                    <div class="line-number"></div>
                    <div class="line-content"></div>
                `;
                return lineDiv;
            }
            
            lineDiv.className += ' ' + cssClass;
            lineDiv.innerHTML = `
                <div class="line-number">${line.oldNum || ''} ${indicator} ${line.newNum || ''}</div>
                <div class="line-content">${escapeHtml(line.content || '')}</div>
            `;
            
            return lineDiv;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Synchronized scrolling
        function setupSynchronizedScrolling() {
            const oldPane = document.getElementById('old-pane');
            const newPane = document.getElementById('new-pane');
            let isScrolling = false;

            function syncScroll(source, target) {
                if (isScrolling) return;
                isScrolling = true;
                target.scrollTop = source.scrollTop;
                setTimeout(() => isScrolling = false, 10);
            }

            oldPane.addEventListener('scroll', () => syncScroll(oldPane, newPane));
            newPane.addEventListener('scroll', () => syncScroll(newPane, oldPane));
        }

        // Handle approve button click
        async function handleApprove() {
            const button = document.getElementById('approve-button');
            const originalText = button.innerHTML;
            
            try {
                // Show loading state
                button.disabled = true;
                button.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="animation: spin 1s linear infinite;">
                        <path d="M8 3a5 5 0 100 10 5 5 0 000-10zM1 8a7 7 0 1114 0A7 7 0 011 8z"/>
                    </svg>
                    Approving...
                `;
                
                // Call approve endpoint
                await apiClient.approve();
                
                // Show success state
                button.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"/>
                    </svg>
                    Approved
                `;
                
                // Re-enable button after 2 seconds
                setTimeout(() => {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }, 2000);
                
            } catch (error) {
                console.error('Failed to approve:', error);
                alert('Failed to approve. Please try again.');
                
                // Reset button state
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }
        
        // Add spin animation style
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Set up approve button handler
            const approveButton = document.getElementById('approve-button');
            approveButton.addEventListener('click', handleApprove);
            
            // Existing initialization code...
            try {
                // Load diff data from API based on query parameters
                let diffData;
                try {
                    if (live || (!commit && !range)) {
                        // Use live diff endpoint
                        const sinceParam = since || 'HEAD';
                        diffData = await apiClient.getLiveDiff(sinceParam);
                    } else {
                        // Use regular diff endpoint for commits/ranges
                        const options = {};
                        if (commit) options.commit = commit;
                        if (range) options.range = range;
                        
                        diffData = await apiClient.getDiff(options);
                    }
                } catch (error) {
                    console.error('API not available:', error);
                    throw error;
                }
                
                // Render the diff
                renderDiff(diffData);
                setupSynchronizedScrolling();
                
            } catch (error) {
                console.error('Failed to initialize application:', error);
                // Show error message to user
                const oldContent = document.getElementById('old-content');
                const newContent = document.getElementById('new-content');
                const errorMsg = `<div style="padding: 20px; color: #d1242f;">Failed to load diff data: ${error.message}</div>`;
                oldContent.innerHTML = errorMsg;
                newContent.innerHTML = errorMsg;
            }
        });
    </script>
</body>
</html>